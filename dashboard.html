<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Academic Results Tracking - Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    :root {
        --bg-primary: #0f0f0f;
        --bg-secondary: #1a1a1a;
        --bg-tertiary: #2a2a2a;
        --accent-primary: #4a90e2;
        --accent-secondary: #357abd;
        --text-primary: #ffffff;
        --text-secondary: #cccccc;
        --text-muted: #888888;
        --danger: #e74c3c;
        --success: #2ecc71;
        --border-radius: 12px;
        --card-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        --transition: all 0.3s ease;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    header {
        background-color: var(--bg-secondary);
        padding: 1.2rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .logo {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .logo::before {
        content: "📊";
        font-size: 1.8rem;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 1.2rem;
    }

    #user-name {
        color: var(--text-secondary);
        font-weight: 500;
    }

    #logout-btn {
        background-color: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--text-muted);
        padding: 0.5rem 1.2rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        font-weight: 500;
    }

    #logout-btn:hover {
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
    }

    main {
        padding: 2.5rem;
        max-width: 1400px;
        margin: 0 auto;
        width: 100%;
        flex: 1;
    }

    .dashboard-header {
        margin-bottom: 2.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .dashboard-title {
        font-size: 1.8rem;
        font-weight: 700;
    }

    .dashboard-actions {
        display: flex;
        gap: 1rem;
    }

    .summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .summary-card {
        background: linear-gradient(145deg, var(--bg-secondary), var(--bg-tertiary));
        padding: 1.8rem;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        text-align: center;
        transition: var(--transition);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 20px rgba(0, 0, 0, 0.25);
    }

    .summary-card h3 {
        margin: 0 0 0.8rem;
        color: var(--text-secondary);
        font-size: 0.95rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .summary-card p {
        font-size: 2.2rem;
        margin: 0;
        color: var(--accent-primary);
        font-weight: 700;
    }

    .subjects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .subject-card {
        background-color: var(--bg-secondary);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        overflow: hidden;
        transition: var(--transition);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .subject-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.25);
    }

    .subject-header {
        padding: 1.5rem;
        background-color: var(--bg-tertiary);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .subject-title {
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .subject-header h2 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .subject-badge {
        background-color: var(--accent-primary);
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
        font-weight: 600;
    }

    .subject-actions {
        display: flex;
        gap: 0.6rem;
    }

    .btn {
        background-color: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--text-muted);
        padding: 0.5rem 0.8rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        font-size: 0.85rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .btn:hover {
        background-color: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
    }

    .btn-primary {
        background-color: var(--accent-primary);
        color: white;
        border: none;
    }

    .btn-primary:hover {
        background-color: var(--accent-secondary);
    }

    .btn-danger {
        color: var(--danger);
        border-color: var(--danger);
    }

    .btn-danger:hover {
        background-color: rgba(231, 76, 60, 0.1);
    }

    .subject-content {
        padding: 1.5rem;
    }

    .subject-average {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
        padding: 0.8rem;
        background-color: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
    }

    .average-label {
        font-weight: 500;
        color: var(--text-secondary);
    }

    .average-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--accent-primary);
    }

    .exams-list {
        margin-bottom: 1.5rem;
    }

    .exam-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.8rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .exam-item:last-child {
        border-bottom: none;
    }

    .exam-info {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
    }

    .exam-name {
        font-weight: 500;
    }

    .exam-mark {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .exam-actions {
        display: flex;
        gap: 0.5rem;
    }

    .add-exam-btn {
        width: 100%;
        margin-top: 0.5rem;
    }

    .add-subject-section {
        text-align: center;
        margin-top: 3rem;
        padding: 2rem;
        border: 2px dashed rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius);
        transition: var(--transition);
    }

    .add-subject-section:hover {
        border-color: var(--accent-primary);
        background-color: rgba(74, 144, 226, 0.05);
    }

    #add-subject-btn {
        background-color: var(--accent-primary);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        font-size: 1rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    #add-subject-btn:hover {
        background-color: var(--accent-secondary);
        transform: translateY(-2px);
    }

    #add-subject-btn::before {
        content: "+";
        font-size: 1.2rem;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background-color: var(--bg-secondary);
        padding: 2.5rem;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 500px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .close {
        color: var(--text-muted);
        position: absolute;
        top: 1.2rem;
        right: 1.5rem;
        font-size: 1.8rem;
        font-weight: bold;
        cursor: pointer;
        transition: var(--transition);
    }

    .close:hover {
        color: var(--text-primary);
    }

    .modal-title {
        margin-bottom: 1.8rem;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text-secondary);
        font-weight: 500;
    }

    input, select {
        width: 100%;
        padding: 0.9rem 1.2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--border-radius);
        background-color: var(--bg-tertiary);
        color: var(--text-primary);
        font-size: 1rem;
        transition: var(--transition);
    }

    input:focus, select:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        margin: 1.5rem 0;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        transform: scale(1.3);
    }

    .form-submit {
        background-color: var(--accent-primary);
        color: white;
        border: none;
        padding: 1rem;
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: var(--transition);
        font-size: 1rem;
        font-weight: 600;
        width: 100%;
        margin-top: 0.5rem;
    }

    .form-submit:hover {
        background-color: var(--accent-secondary);
    }

    .compulsory-badge {
        background-color: var(--success);
        color: white;
        font-size: 0.7rem;
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
        font-weight: 600;
        margin-left: 0.5rem;
    }

    @media (max-width: 1000px) {
        .subjects-grid {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
    }

    @media (max-width: 768px) {
        main {
            padding: 1.5rem;
        }
        
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .summary {
            grid-template-columns: 1fr;
        }
        
        .subjects-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        header {
            padding: 1rem;
            flex-direction: column;
            gap: 1rem;
        }
        
        main {
            padding: 1rem;
        }
        
        .subject-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .subject-actions {
            width: 100%;
            justify-content: space-between;
        }
    }
</style>
</head>
<body>
<header>
    <div class="logo">Academic Results Tracking</div>
    <div class="user-info">
        <span id="user-name"></span>
        <button id="logout-btn">Logout</button>
    </div>
</header>
<main>
    <div class="dashboard-header">
        <h1 class="dashboard-title">Academic Dashboard</h1>
        <div class="dashboard-actions">
            <button class="btn" id="help-btn">Help</button>
        </div>
    </div>
    
    <section class="summary">
        <div class="summary-card">
            <h3>Overall Average</h3>
            <p id="overall-average">0%</p>
        </div>
        <div class="summary-card">
            <h3>Total Subjects</h3>
            <p id="total-subjects">0</p>
        </div>
        <div class="summary-card">
            <h3>Total Exams</h3>
            <p id="total-exams">0</p>
        </div>
        <div class="summary-card">
            <h3>Best Subject</h3>
            <p id="best-subject">-</p>
        </div>
    </section>
    
    <h2 style="margin-bottom: 1.5rem; font-weight: 600;">Your Subjects</h2>
    <section class="subjects-grid" id="subjects-container"></section>
    
    <div class="add-subject-section">
        <button class="add-btn" id="add-subject-btn">Add Subject</button>
    </div>
</main>

<!-- Subject Modal -->
<div id="subject-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="subject-close">&times;</span>
        <h2 class="modal-title" id="subject-modal-title">Add Subject</h2>
        <form id="subject-form">
            <div class="form-group">
                <label for="subject-name">Subject Name</label>
                <input type="text" id="subject-name" placeholder="Enter subject name" required>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="is-advanced">
                <label for="is-advanced">Advanced Subject</label>
            </div>
            <button type="submit" class="form-submit">Save Subject</button>
        </form>
    </div>
</div>

<!-- Exam Modal -->
<div id="exam-modal" class="modal">
    <div class="modal-content">
        <span class="close" id="exam-close">&times;</span>
        <h2 class="modal-title" id="exam-modal-title">Add Exam</h2>
        <form id="exam-form">
            <div class="form-group">
                <label for="exam-name">Exam Name</label>
                <input type="text" id="exam-name" placeholder="Enter exam name" required>
            </div>
            <div class="form-group">
                <label for="exam-mark">Mark (0-100)</label>
                <input type="number" id="exam-mark" placeholder="Enter mark" min="0" max="100" required>
            </div>
            <button type="submit" class="form-submit">Save Exam</button>
        </form>
    </div>
</div>

<script>
(async function() {
    // 1️⃣ Initialize Supabase FIRST
    const supabaseUrl = 'https://dasbgtczrqdwjzxlohaq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhc2JndGN6cnFkd2p6eGxvaGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MzI4MzIsImV4cCI6MjA3MzUwODgzMn0.jukHtZwDO-m9w8VQPG-cSs_me2degc_5XV1wTeC8poA';
    const { createClient } = supabase; // Reference the global supabase from CDN
    const supabaseClient = createClient(supabaseUrl, supabaseKey);

    // 2️⃣ DOM Elements
    const userName = document.getElementById('user-name');
    const logoutBtn = document.getElementById('logout-btn');
    const overallAverage = document.getElementById('overall-average');
    const totalSubjects = document.getElementById('total-subjects');
    const totalExams = document.getElementById('total-exams');
    const bestSubject = document.getElementById('best-subject');
    const subjectsContainer = document.getElementById('subjects-container');
    const addSubjectBtn = document.getElementById('add-subject-btn');
    const helpBtn = document.getElementById('help-btn');

    const subjectModal = document.getElementById('subject-modal');
    const subjectClose = document.getElementById('subject-close');
    const subjectForm = document.getElementById('subject-form');
    const subjectNameInput = document.getElementById('subject-name');
    const isAdvancedInput = document.getElementById('is-advanced');
    const subjectModalTitle = document.getElementById('subject-modal-title');

    const examModal = document.getElementById('exam-modal');
    const examClose = document.getElementById('exam-close');
    const examForm = document.getElementById('exam-form');
    const examNameInput = document.getElementById('exam-name');
    const examMarkInput = document.getElementById('exam-mark');
    const examModalTitle = document.getElementById('exam-modal-title');

    let currentSubjectId = null;
    let currentExamId = null;
    let currentExamSubjectId = null;
    
    // Compulsory subjects
    const compulsorySubjects = ['Mathematics', 'First Additional Language', 'Second Additional Language', 'Life Orientation'];

    // 3️⃣ Auth check
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) return window.location.href = 'login.html';

    const { data: profile } = await supabaseClient.from('profiles').select('name').eq('id', session.user.id).single();
    userName.textContent = `Welcome, ${profile.name}`;

    // 4️⃣ Load subjects
    async function loadSubjects() {
        const { data: subjects } = await supabaseClient.from('subjects').select('*').eq('student_id', session.user.id).order('created_at', { ascending: true });
        
        // Ensure compulsory subjects exist
        for (const subjectName of compulsorySubjects) {
            const exists = subjects.some(s => s.name === subjectName);
            if (!exists) {
                const { error } = await supabaseClient.from('subjects').insert({
                    student_id: session.user.id,
                    name: subjectName,
                    is_advanced: false,
                    is_compulsory: true
                });
                if (error) console.error('Error creating compulsory subject:', error);
            }
        }
        
        // Reload subjects after ensuring compulsory ones exist
        const { data: updatedSubjects } = await supabaseClient.from('subjects').select('*').eq('student_id', session.user.id).order('created_at', { ascending: true });
        
        subjectsContainer.innerHTML = '';
        let allMarks = [];
        let examCount = 0;
        let subjectAverages = [];
        
        for (const subject of updatedSubjects || []) {
            const { data: exams } = await supabaseClient.from('exams').select('*').eq('subject_id', subject.subject_id).order('created_at', { ascending: true });
            renderSubject(subject, exams || []);
            
            // Calculate subject average
            const subjectAvg = exams.length ? exams.reduce((a, b) => a + b.mark, 0) / exams.length : 0;
            if (exams.length > 0) {
                subjectAverages.push({
                    name: subject.name,
                    average: subjectAvg,
                    isAdvanced: subject.is_advanced,
                    isCompulsory: subject.is_compulsory
                });
            }
            
            allMarks = allMarks.concat((exams || []).map(e => e.mark));
            examCount += (exams || []).length;
        }
        
        updateSummary(updatedSubjects || [], allMarks, examCount, subjectAverages);
    }

    function renderSubject(subject, exams) {
        const subjectAverage = exams.length ? exams.reduce((a, b) => a + b.mark, 0) / exams.length : 0;
        const card = document.createElement('div');
        card.className = 'subject-card';
        card.innerHTML = `
            <div class="subject-header">
                <div class="subject-title">
                    <h2>${subject.name}</h2>
                    ${subject.is_advanced ? '<span class="subject-badge">Advanced</span>' : ''}
                    ${subject.is_compulsory ? '<span class="compulsory-badge">Compulsory</span>' : ''}
                </div>
                <div class="subject-actions">
                    <button class="btn" data-action="edit-subject" data-id="${subject.subject_id}">Edit</button>
                    ${!subject.is_compulsory ? `<button class="btn btn-danger" data-action="delete-subject" data-id="${subject.subject_id}">Delete</button>` : ''}
                </div>
            </div>
            <div class="subject-content">
                <div class="subject-average">
                    <span class="average-label">Subject Average</span>
                    <span class="average-value">${subjectAverage.toFixed(2)}%</span>
                </div>
                <div class="exams-list" id="exams-${subject.subject_id}">
                    ${exams.length > 0 ? exams.map(exam => `
                        <div class="exam-item">
                            <div class="exam-info">
                                <span class="exam-name">${exam.exam_name}</span>
                                <span class="exam-mark">${exam.mark}%</span>
                            </div>
                            <div class="exam-actions">
                                <button class="btn" data-action="edit-exam" data-id="${exam.exam_id}" data-subject-id="${subject.subject_id}">Edit</button>
                                <button class="btn btn-danger" data-action="delete-exam" data-id="${exam.exam_id}">Delete</button>
                            </div>
                        </div>
                    `).join('') : '<p style="color: var(--text-muted); text-align: center;">No exams added yet</p>'}
                </div>
                <button class="btn btn-primary add-exam-btn" data-action="add-exam" data-id="${subject.subject_id}">Add Exam</button>
            </div>
        `;
        subjectsContainer.appendChild(card);
    }

    function updateSummary(subjects, allMarks, examCount, subjectAverages) {
        // Calculate overall average based on the rules
        let overallAvg = calculateOverallAverage(subjectAverages);
        
        overallAverage.textContent = `${overallAvg.toFixed(2)}%`;
        totalSubjects.textContent = subjects.length;
        totalExams.textContent = examCount;
        
        // Find best subject
        if (subjectAverages.length > 0) {
            const best = subjectAverages.reduce((prev, current) => 
                (prev.average > current.average) ? prev : current
            );
            bestSubject.textContent = `${best.name} (${best.average.toFixed(2)}%)`;
        } else {
            bestSubject.textContent = '-';
        }
    }
    
    function calculateOverallAverage(subjectAverages) {
        if (subjectAverages.length === 0) return 0;
        
        // Separate compulsory and optional subjects
        const compulsorySubs = subjectAverages.filter(s => s.isCompulsory);
        const optionalSubs = subjectAverages.filter(s => !s.isCompulsory && !s.isAdvanced);
        const advancedSubs = subjectAverages.filter(s => s.isAdvanced);
        
        // Calculate compulsory average
        const compulsoryAvg = compulsorySubs.length > 0 ? 
            compulsorySubs.reduce((sum, sub) => sum + sub.average, 0) / compulsorySubs.length : 0;
        
        // Calculate optional average (top 3 only)
        optionalSubs.sort((a, b) => b.average - a.average);
        const topOptionalSubs = optionalSubs.slice(0, 3);
        const optionalAvg = topOptionalSubs.length > 0 ? 
            topOptionalSubs.reduce((sum, sub) => sum + sub.average, 0) / topOptionalSubs.length : 0;
        
        // Calculate advanced average (all count)
        const advancedAvg = advancedSubs.length > 0 ? 
            advancedSubs.reduce((sum, sub) => sum + sub.average, 0) / advancedSubs.length : 0;
        
        // Calculate overall average (weighted)
        const totalSubjectsCount = compulsorySubs.length + Math.min(optionalSubs.length, 3) + advancedSubs.length;
        
        if (totalSubjectsCount === 0) return 0;
        
        const overallAvg = (compulsoryAvg * compulsorySubs.length + 
                           optionalAvg * Math.min(optionalSubs.length, 3) + 
                           advancedAvg * advancedSubs.length) / totalSubjectsCount;
        
        return overallAvg;
    }

    // 5️⃣ Subject modal
    addSubjectBtn.addEventListener('click', () => openSubjectModal(null));

    async function openSubjectModal(subjectId) {
        currentSubjectId = subjectId;
        if (subjectId) {
            const { data } = await supabaseClient.from('subjects').select('*').eq('subject_id', subjectId).single();
            subjectNameInput.value = data.name;
            isAdvancedInput.checked = data.is_advanced;
            subjectModalTitle.textContent = 'Edit Subject';
        } else {
            subjectNameInput.value = '';
            isAdvancedInput.checked = false;
            subjectModalTitle.textContent = 'Add Subject';
        }
        subjectModal.style.display = 'flex';
    }

    subjectClose.addEventListener('click', () => subjectModal.style.display = 'none');

    subjectForm.addEventListener('submit', async e => {
        e.preventDefault();
        const name = subjectNameInput.value;
        const isAdvanced = isAdvancedInput.checked;
        
        // Check if subject is compulsory
        const isCompulsory = compulsorySubjects.includes(name);
        
        if (currentSubjectId) {
            const { error } = await supabaseClient.from('subjects').update({ 
                name, 
                is_advanced: isAdvanced,
                is_compulsory: isCompulsory
            }).eq('subject_id', currentSubjectId);
            if (error) console.error(error);
        } else {
            const { error } = await supabaseClient.from('subjects').insert({ 
                student_id: session.user.id, 
                name, 
                is_advanced: isAdvanced,
                is_compulsory: isCompulsory
            });
            if (error) console.error(error);
        }
        subjectModal.style.display = 'none';
        loadSubjects();
    });

    async function deleteSubject(subjectId) {
        if (confirm('Are you sure you want to delete this subject and all its exams?')) {
            const { error: subjectError } = await supabaseClient.from('subjects').delete().eq('subject_id', subjectId);
            if (subjectError) console.error(subjectError);
            const { error: examsError } = await supabaseClient.from('exams').delete().eq('subject_id', subjectId);
            if (examsError) console.error(examsError);
            loadSubjects();
        }
    }

    // 6️⃣ Exam modal
    async function openExamModal(subjectId, examId) {
        currentExamSubjectId = subjectId;
        currentExamId = examId;
        if (examId) {
            const { data } = await supabaseClient.from('exams').select('*').eq('exam_id', examId).single();
            examNameInput.value = data.exam_name;
            examMarkInput.value = data.mark;
            examModalTitle.textContent = 'Edit Exam';
        } else {
            examNameInput.value = '';
            examMarkInput.value = '';
            examModalTitle.textContent = 'Add Exam';
        }
        examModal.style.display = 'flex';
    }

    examClose.addEventListener('click', () => examModal.style.display = 'none');

    examForm.addEventListener('submit', async e => {
        e.preventDefault();
        const name = examNameInput.value;
        const mark = parseFloat(examMarkInput.value);
        if (currentExamId) {
            const { error } = await supabaseClient.from('exams').update({ exam_name: name, mark }).eq('exam_id', currentExamId);
            if (error) console.error(error);
        } else {
            const { error } = await supabaseClient.from('exams').insert({ subject_id: currentExamSubjectId, exam_name: name, mark });
            if (error) console.error(error);
        }
        examModal.style.display = 'none';
        loadSubjects();
    });

    async function deleteExam(examId) {
        if (confirm('Are you sure you want to delete this exam?')) {
            const { error } = await supabaseClient.from('exams').delete().eq('exam_id', examId);
            if (error) console.error(error);
            loadSubjects();
        }
    }

    // 7️⃣ Logout
    logoutBtn.addEventListener('click', async () => {
        await supabaseClient.auth.signOut();
        window.location.href = 'login.html';
    });
    
    // Help button
    helpBtn.addEventListener('click', () => {
        alert('How it works:\n\n1. All users start with Mathematics, First Additional Language, Second Additional Language, and Life Orientation as compulsory subjects.\n\n2. You can add additional subjects and mark them as advanced if needed.\n\n3. Only the top three non-advanced subjects contribute to your overall average.\n\n4. All compulsory and advanced subjects count toward your average.');
    });

    // 8️⃣ Close modals on outside click
    window.addEventListener('click', e => {
        if (e.target === subjectModal) subjectModal.style.display = 'none';
        if (e.target === examModal) examModal.style.display = 'none';
    });

    // 9️⃣ Handle dynamic button clicks (replacing inline onclicks)
    subjectsContainer.addEventListener('click', async e => {
        const target = e.target;
        if (target.tagName === 'BUTTON') {
            const action = target.dataset.action;
            const id = target.dataset.id;
            const subjectId = target.dataset.subjectId || target.closest('.subject-card')?.querySelector('.subject-header')?.querySelector('[data-action="edit-subject"]')?.dataset.id;

            if (action === 'edit-subject') {
                await openSubjectModal(id);
            } else if (action === 'delete-subject') {
                await deleteSubject(id);
            } else if (action === 'add-exam') {
                await openExamModal(id, null);
            } else if (action === 'edit-exam') {
                await openExamModal(subjectId, id);
            } else if (action === 'delete-exam') {
                await deleteExam(id);
            }
        }
    });

    // 🔟 Initial load
    loadSubjects();

})();
</script>
</body>
</html>

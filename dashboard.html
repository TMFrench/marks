<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Academic Results Tracking - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --accent-primary: #4a90e2;
            --accent-secondary: #357abd;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-muted: #888888;
            --danger: #e74c3c;
            --success: #2ecc71;
            --border-radius: 12px;
            --card-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            --transition: all 0.25s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--bg-secondary);
            padding: 1.2rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo { font-size: 1.5rem; font-weight: 700; color: var(--accent-primary); display:flex; gap:0.5rem; align-items:center;}
        .logo::before { content: "üìä"; font-size: 1.6rem; }

        .user-info { display:flex; align-items:center; gap:1rem; }
        #user-name { color: var(--text-secondary); font-weight: 500; }
        #logout-btn { background: transparent; color: var(--text-secondary); border: 1px solid var(--text-muted); padding:0.45rem 0.9rem; border-radius: 10px; cursor:pointer;}

        main { padding: 2rem; max-width: 1200px; margin: 0 auto; width: 100%; flex:1; }

        .dashboard-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.6rem; gap:1rem; }
        .dashboard-title { font-size:1.6rem; font-weight:700; }

        .summary { display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-bottom:1.8rem; }
        .summary-card { background: linear-gradient(145deg,var(--bg-secondary),var(--bg-tertiary)); padding:1.2rem; border-radius:var(--border-radius); box-shadow:var(--card-shadow); border:1px solid rgba(255,255,255,0.03); text-align:center; }
        .summary-card h3 { color: var(--text-secondary); font-size:0.85rem; margin-bottom:0.4rem; text-transform:uppercase; letter-spacing:0.6px; }
        .summary-card p { font-size:1.6rem; color:var(--accent-primary); font-weight:700; margin:0; }

        .subjects-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(340px,1fr)); gap:1.25rem; }
        .subject-card { background: var(--bg-secondary); border-radius:var(--border-radius); box-shadow:var(--card-shadow); overflow:hidden; border:1px solid rgba(255,255,255,0.03); transition:var(--transition); }
        .subject-header { padding:1rem; background:var(--bg-tertiary); display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.03); }
        .subject-title { display:flex; align-items:center; gap:0.6rem; }
        .subject-badge { background:var(--accent-primary); color:white; padding:0.2rem 0.5rem; border-radius:16px; font-weight:600; font-size:0.75rem; }
        .compulsory-badge { background:var(--success); color:white; padding:0.2rem 0.5rem; border-radius:16px; font-weight:600; font-size:0.72rem; margin-left:0.4rem; }

        .subject-actions { display:flex; gap:0.5rem; }

        .btn { background:transparent; color:var(--text-secondary); border:1px solid var(--text-muted); padding:0.45rem 0.7rem; border-radius:10px; cursor:pointer; font-weight:500; display:inline-flex; gap:0.4rem; align-items:center; }
        .btn:hover { background: rgba(255,255,255,0.03); color:var(--text-primary); }
        .btn-primary { background:var(--accent-primary); color:white; border:none; padding:0.6rem 0.9rem; }
        .btn-danger { color:var(--danger); border-color:var(--danger); }
        .add-exam-btn { margin-top:0.8rem; width:100%; }

        .subject-content { padding:1rem; }
        .subject-average { display:flex; justify-content:space-between; align-items:center; padding:0.6rem; background: rgba(255,255,255,0.02); border-radius:8px; margin-bottom:1rem; }
        .average-label { color:var(--text-secondary); font-weight:500; }
        .average-value { color:var(--accent-primary); font-weight:700; font-size:1.1rem; }

        .exams-list { margin-bottom:0.6rem; }
        .exam-item { display:flex; justify-content:space-between; align-items:center; padding:0.6rem 0; border-bottom:1px solid rgba(255,255,255,0.03); }
        .exam-item:last-child { border-bottom:none; }
        .exam-name { font-weight:500; }
        .exam-mark { color:var(--text-secondary); font-size:0.9rem; }

        .add-subject-section { text-align:center; margin-top:1.5rem; padding:1.6rem; border:2px dashed rgba(255,255,255,0.06); border-radius:var(--border-radius); }
        #add-subject-btn { background:var(--accent-primary); color:white; border:none; padding:0.9rem 1.4rem; border-radius:var(--border-radius); cursor:pointer; }

        /* Modal */
        .modal { display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1200; }
        .modal-content { background:var(--bg-secondary); padding:1.6rem; border-radius:12px; width:92%; max-width:480px; border:1px solid rgba(255,255,255,0.04); }
        .close { position:absolute; right:1rem; top:1rem; font-size:1.4rem; cursor:pointer; color:var(--text-muted); }

        .form-group { margin-bottom:1rem; }
        label { display:block; color:var(--text-secondary); margin-bottom:0.4rem; font-weight:600; }
        input, select { width:100%; padding:0.7rem; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:var(--bg-tertiary); color:var(--text-primary); }

        .loading { padding:2rem; text-align:center; color:var(--text-muted); }

        @media (max-width: 800px) {
            .subjects-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Academic Results Tracking</div>
        <div class="user-info">
            <span id="user-name">Loading...</span>
            <button id="logout-btn">Logout</button>
        </div>
    </header>

    <main>
        <div class="dashboard-header">
            <h1 class="dashboard-title">Academic Dashboard</h1>
            <div>
                <button class="btn" id="help-btn">Help</button>
            </div>
        </div>

        <section class="summary">
            <div class="summary-card">
                <h3>Overall Average</h3>
                <p id="overall-average">0%</p>
            </div>
            <div class="summary-card">
                <h3>Total Subjects</h3>
                <p id="total-subjects">0</p>
            </div>
            <div class="summary-card">
                <h3>Total Exams</h3>
                <p id="total-exams">0</p>
            </div>
            <div class="summary-card">
                <h3>Best Subject</h3>
                <p id="best-subject">-</p>
            </div>
        </section>

        <h2 style="margin-bottom:1rem; font-weight:600;">Your Subjects</h2>
        <section class="subjects-grid" id="subjects-container">
            <div class="loading">Loading subjects...</div>
        </section>

        <div class="add-subject-section">
            <button id="add-subject-btn">Add Subject</button>
        </div>
    </main>

    <!-- Subject Modal -->
    <div id="subject-modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <span class="close" id="subject-close">&times;</span>
            <h2 id="subject-modal-title">Add Subject</h2>
            <form id="subject-form">
                <div class="form-group">
                    <label for="subject-name">Subject Name</label>
                    <input id="subject-name" type="text" required placeholder="e.g. Physics">
                </div>
                <div class="form-group">
                    <label>
                        <input id="is-advanced" type="checkbox"> Advanced Subject
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" id="subject-save-btn">Save Subject</button>
            </form>
        </div>
    </div>

    <!-- Exam Modal -->
    <div id="exam-modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <span class="close" id="exam-close">&times;</span>
            <h2 id="exam-modal-title">Add Exam</h2>
            <form id="exam-form">
                <div class="form-group">
                    <label for="exam-name">Exam Name</label>
                    <input id="exam-name" type="text" required placeholder="e.g. Term 1">
                </div>
                <div class="form-group">
                    <label for="exam-mark">Mark (0-100)</label>
                    <input id="exam-mark" type="number" min="0" max="100" required placeholder="e.g. 72">
                </div>
                <button type="submit" class="btn btn-primary" id="exam-save-btn">Save Exam</button>
            </form>
        </div>
    </div>

    <script>
    (async function () {
        // 1Ô∏è‚É£ Initialize Supabase client immediately
        const supabaseUrl = 'https://dasbgtczrqdwjzxlohaq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRhc2JndGN6cnFkd2p6eGxvaGFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5MzI4MzIsImV4cCI6MjA3MzUwODgzMn0.jukHtZwDO-m9w8VQPG-cSs_me2degc_5XV1wTeC8poA';
        // create client (global provided by the CDN)
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // DOM elements
        const userNameEl = document.getElementById('user-name');
        const logoutBtn = document.getElementById('logout-btn');
        const overallAverageEl = document.getElementById('overall-average');
        const totalSubjectsEl = document.getElementById('total-subjects');
        const totalExamsEl = document.getElementById('total-exams');
        const bestSubjectEl = document.getElementById('best-subject');
        const subjectsContainer = document.getElementById('subjects-container');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        const helpBtn = document.getElementById('help-btn');

        const subjectModal = document.getElementById('subject-modal');
        const subjectClose = document.getElementById('subject-close');
        const subjectForm = document.getElementById('subject-form');
        const subjectNameInput = document.getElementById('subject-name');
        const isAdvancedInput = document.getElementById('is-advanced');
        const subjectModalTitle = document.getElementById('subject-modal-title');

        const examModal = document.getElementById('exam-modal');
        const examClose = document.getElementById('exam-close');
        const examForm = document.getElementById('exam-form');
        const examNameInput = document.getElementById('exam-name');
        const examMarkInput = document.getElementById('exam-mark');
        const examModalTitle = document.getElementById('exam-modal-title');

        let currentSubjectId = null;
        let currentExamId = null;
        let currentExamSubjectId = null;
        let session = null;
        let profile = null;

        // Compulsory subjects ONLY for initial profile creation
        const compulsorySubjectsToCreate = [
            { name: 'Mathematics' },
            { name: 'First Additional Language' },
            { name: 'Home Language' },
            { name: 'Life Orientation' }
        ];

        // 2Ô∏è‚É£ Auth / session check
        try {
            const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
            if (sessionError) {
                console.error('Session fetch error:', sessionError);
                window.location.href = 'index.html';
                return;
            }
            session = sessionData?.session;
            if (!session) {
                // no session => redirect to login
                window.location.href = 'index.html';
                return;
            }
        } catch (err) {
            console.error('Exception getting session:', err);
            window.location.href = 'index.html';
            return;
        }

        // 3Ô∏è‚É£ Load or create profile. When we INSERT the profile we also create the compulsory subjects.
        async function loadOrCreateProfile() {
            try {
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('id, name')
                    .eq('id', session.user.id)
                    .single();

                if (error) {
                    // If profile not found, create it and create compulsory subjects
                    console.warn('Profile not found or error, creating profile:', error?.message || error);
                    const defaultName = session.user.user_metadata?.full_name || session.user.email?.split('@')[0] || 'Student';
                    const { data: newProfile, error: insertErr } = await supabaseClient
                        .from('profiles')
                        .insert([{ id: session.user.id, name: defaultName }])
                        .select()
                        .single();

                    if (insertErr) {
                        console.error('Error creating profile:', insertErr);
                        profile = { id: session.user.id, name: defaultName };
                        userNameEl.textContent = `Welcome, ${profile.name}`;
                        return;
                    }

                    profile = newProfile;
                    userNameEl.textContent = `Welcome, ${profile.name}`;

                    // Create the four compulsory subjects ONCE, marking them as is_compulsory
                    try {
                        const inserts = compulsorySubjectsToCreate.map(s => ({
                            student_id: session.user.id,
                            name: s.name,
                            is_advanced: false,
                            is_compulsory: true
                        }));
                        const { error: subjErr } = await supabaseClient.from('subjects').insert(inserts);
                        if (subjErr) console.error('Error creating compulsory subjects:', subjErr);
                    } catch (err) {
                        console.error('Exception creating compulsory subjects:', err);
                    }

                } else {
                    profile = data;
                    userNameEl.textContent = `Welcome, ${profile.name}`;
                }
            } catch (err) {
                console.error('Exception loading/creating profile:', err);
                userNameEl.textContent = 'Welcome';
            }
        }

        await loadOrCreateProfile();

        // 4Ô∏è‚É£ Load subjects & exams (no longer creates compulsory subjects here)
        async function loadSubjects() {
            subjectsContainer.innerHTML = '<div class="loading">Loading subjects...</div>';
            try {
                const { data: subjects, error: subjectsError } = await supabaseClient
                    .from('subjects')
                    .select('*')
                    .eq('student_id', session.user.id)
                    .order('created_at', { ascending: true });

                if (subjectsError) {
                    console.error('Error loading subjects:', subjectsError);
                    subjectsContainer.innerHTML = '<div class="loading">Error loading subjects. Please refresh the page.</div>';
                    return;
                }

                if (!subjects || subjects.length === 0) {
                    subjectsContainer.innerHTML = '<div class="loading">No subjects found. Add your first subject above.</div>';
                    updateSummary([], [], 0, []);
                    return;
                }

                // Clear and render each subject with its exams
                subjectsContainer.innerHTML = '';
                let allMarks = [];
                let examCount = 0;
                let subjectAverages = [];

                for (const subject of subjects) {
                    const { data: exams, error: examsError } = await supabaseClient
                        .from('exams')
                        .select('*')
                        .eq('subject_id', subject.subject_id)
                        .order('created_at', { ascending: true });

                    if (examsError) {
                        console.error(`Error loading exams for subject ${subject.subject_id}:`, examsError);
                        continue;
                    }

                    renderSubject(subject, exams || []);

                    // calculate subject average
                    const avg = (exams && exams.length) ? (exams.reduce((sum, e) => sum + Number(e.mark), 0) / exams.length) : 0;
                    if (exams && exams.length) {
                        subjectAverages.push({
                            subject_id: subject.subject_id,
                            name: subject.name,
                            average: avg,
                            isAdvanced: !!subject.is_advanced,
                            isCompulsory: !!subject.is_compulsory
                        });
                        allMarks = allMarks.concat(exams.map(e => Number(e.mark)));
                        examCount += exams.length;
                    }
                }

                updateSummary(subjects, allMarks, examCount, subjectAverages);

            } catch (err) {
                console.error('Exception loading subjects:', err);
                subjectsContainer.innerHTML = '<div class="loading">Error loading subjects. Please refresh the page.</div>';
            }
        }

        // Render a subject card
        function renderSubject(subject, exams) {
            const subjectAverage = (exams && exams.length) ? (exams.reduce((a, b) => a + Number(b.mark), 0) / exams.length) : 0;
            const isCompulsory = !!subject.is_compulsory;
            const isAdvanced = !!subject.is_advanced;

            const card = document.createElement('div');
            card.className = 'subject-card';
            card.innerHTML = `
                <div class="subject-header">
                    <div class="subject-title">
                        <h2 style="margin:0; font-size:1.05rem;">${escapeHtml(subject.name)}</h2>
                        ${isAdvanced ? '<span class="subject-badge">Advanced</span>' : ''}
                        ${isCompulsory ? '<span class="compulsory-badge">Compulsory</span>' : ''}
                    </div>
                    <div class="subject-actions">
                        <button class="btn" data-action="edit-subject" data-id="${subject.subject_id}">Edit</button>
                        ${!isCompulsory ? `<button class="btn btn-danger" data-action="delete-subject" data-id="${subject.subject_id}">Delete</button>` : ''}
                    </div>
                </div>
                <div class="subject-content">
                    <div class="subject-average">
                        <span class="average-label">Subject Average</span>
                        <span class="average-value">${subjectAverage.toFixed(2)}%</span>
                    </div>
                    <div class="exams-list" id="exams-${subject.subject_id}">
                        ${exams && exams.length > 0 ? exams.map(exam => `
                            <div class="exam-item">
                                <div class="exam-info">
                                    <span class="exam-name">${escapeHtml(exam.exam_name)}</span>
                                    <span class="exam-mark">${Number(exam.mark)}%</span>
                                </div>
                                <div class="exam-actions">
                                    <button class="btn" data-action="edit-exam" data-id="${exam.exam_id}" data-subject-id="${subject.subject_id}">Edit</button>
                                    <button class="btn btn-danger" data-action="delete-exam" data-id="${exam.exam_id}">Delete</button>
                                </div>
                            </div>
                        `).join('') : '<p style="color: var(--text-muted); text-align:center;">No exams added yet</p>'}
                    </div>
                    <button class="btn btn-primary add-exam-btn" data-action="add-exam" data-id="${subject.subject_id}">Add Exam</button>
                </div>
            `;
            subjectsContainer.appendChild(card);
        }

        // Summary and average maths (uses is_compulsory flag)
        function updateSummary(subjects, allMarks, examCount, subjectAverages) {
            let overallAvg = calculateOverallAverage(subjectAverages);
            overallAverageEl.textContent = `${overallAvg.toFixed(2)}%`;
            totalSubjectsEl.textContent = subjects.length;
            totalExamsEl.textContent = examCount;

            if (subjectAverages.length > 0) {
                const best = subjectAverages.reduce((prev, curr) => prev.average > curr.average ? prev : curr);
                bestSubjectEl.textContent = `${best.name} (${best.average.toFixed(2)}%)`;
            } else {
                bestSubjectEl.textContent = '-';
            }
        }

        function calculateOverallAverage(subjectAverages) {
            if (!subjectAverages || subjectAverages.length === 0) return 0;

            // Exclude advanced subjects entirely
            const nonAdvanced = subjectAverages.filter(s => !s.isAdvanced);

            // compulsory and optional separation using isCompulsory flag
            const compulsory = nonAdvanced.filter(s => s.isCompulsory);
            const optional = nonAdvanced.filter(s => !s.isCompulsory);

            const compulsoryAvg = compulsory.length > 0 ? (compulsory.reduce((sum, s) => sum + s.average, 0) / compulsory.length) : 0;

            optional.sort((a, b) => b.average - a.average);
            const topOptional = optional.slice(0, 3);
            const optionalAvg = topOptional.length > 0 ? (topOptional.reduce((sum, s) => sum + s.average, 0) / topOptional.length) : 0;

            const totalCount = compulsory.length + Math.min(optional.length, 3);
            if (totalCount === 0) return 0;

            return (compulsoryAvg * compulsory.length + optionalAvg * Math.min(optional.length, 3)) / totalCount;
        }

        // 5Ô∏è‚É£ Subject modal handling
        addSubjectBtn.addEventListener('click', () => openSubjectModal(null));

        async function openSubjectModal(subjectId) {
            currentSubjectId = subjectId;
            if (subjectId) {
                const { data, error } = await supabaseClient.from('subjects').select('*').eq('subject_id', subjectId).single();
                if (error) {
                    console.error('Error fetching subject for edit:', error);
                    return;
                }
                subjectNameInput.value = data.name;
                isAdvancedInput.checked = !!data.is_advanced;
                subjectModalTitle.textContent = 'Edit Subject';
            } else {
                subjectNameInput.value = '';
                isAdvancedInput.checked = false;
                subjectModalTitle.textContent = 'Add Subject';
            }
            subjectModal.style.display = 'flex';
        }

        subjectClose.addEventListener('click', () => subjectModal.style.display = 'none');

        // Escape HTML helper to avoid injection in rendered names
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        subjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = subjectNameInput.value.trim();
            const isAdvanced = isAdvancedInput.checked;

            if (!name) {
                alert('Please enter a subject name.');
                return;
            }

            if (currentSubjectId) {
                // Update existing subject (preserve is_compulsory flag)
                const { error } = await supabaseClient.from('subjects').update({
                    name,
                    is_advanced: isAdvanced
                }).eq('subject_id', currentSubjectId);
                if (error) {
                    console.error('Error updating subject:', error);
                    alert('Error updating subject. Please try again.');
                    return;
                }
            } else {
                // Insert new subject (non-compulsory by default)
                const { error } = await supabaseClient.from('subjects').insert({
                    student_id: session.user.id,
                    name,
                    is_advanced: isAdvanced,
                    is_compulsory: false
                });
                if (error) {
                    console.error('Error creating subject:', error);
                    alert('Error creating subject. Please try again.');
                    return;
                }
            }

            subjectModal.style.display = 'none';
            await loadSubjects();
        });

        // Delete subject (only if not compulsory)
        async function deleteSubject(subjectId) {
            // check subject first
            const { data: subj, error: subErr } = await supabaseClient.from('subjects').select('is_compulsory').eq('subject_id', subjectId).single();
            if (subErr) {
                console.error('Error fetching subject before delete:', subErr);
                alert('Could not delete subject. Try again.');
                return;
            }
            if (subj.is_compulsory) {
                alert('Cannot delete a compulsory subject.');
                return;
            }

            if (!confirm('Are you sure you want to delete this subject and all its exams?')) return;

            const { error: examsError } = await supabaseClient.from('exams').delete().eq('subject_id', subjectId);
            if (examsError) console.error('Error deleting exams:', examsError);

            const { error: subjectError } = await supabaseClient.from('subjects').delete().eq('subject_id', subjectId);
            if (subjectError) {
                console.error('Error deleting subject:', subjectError);
                alert('Error deleting subject. Please try again.');
                return;
            }

            await loadSubjects();
        }

        // 6Ô∏è‚É£ Exam modal handling
        async function openExamModal(subjectId, examId) {
            currentExamSubjectId = subjectId;
            currentExamId = examId;
            if (examId) {
                const { data, error } = await supabaseClient.from('exams').select('*').eq('exam_id', examId).single();
                if (error) {
                    console.error('Error loading exam for edit:', error);
                    return;
                }
                examNameInput.value = data.exam_name;
                examMarkInput.value = data.mark;
                examModalTitle.textContent = 'Edit Exam';
            } else {
                examNameInput.value = '';
                examMarkInput.value = '';
                examModalTitle.textContent = 'Add Exam';
            }
            examModal.style.display = 'flex';
        }

        examClose.addEventListener('click', () => examModal.style.display = 'none');

        examForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = examNameInput.value.trim();
            const mark = parseFloat(examMarkInput.value);

            if (!name || isNaN(mark)) {
                alert('Please enter a valid exam name and mark.');
                return;
            }

            if (mark < 0 || mark > 100) {
                alert('Mark must be between 0 and 100.');
                return;
            }

            if (currentExamId) {
                const { error } = await supabaseClient.from('exams').update({ exam_name: name, mark }).eq('exam_id', currentExamId);
                if (error) {
                    console.error('Error updating exam:', error);
                    alert('Error updating exam. Please try again.');
                    return;
                }
            } else {
                const { error } = await supabaseClient.from('exams').insert({ subject_id: currentExamSubjectId, exam_name: name, mark });
                if (error) {
                    console.error('Error creating exam:', error);
                    alert('Error creating exam. Please try again.');
                    return;
                }
            }

            examModal.style.display = 'none';
            await loadSubjects();
        });

        // Delete exam
        async function deleteExam(examId) {
            if (!confirm('Are you sure you want to delete this exam?')) return;
            const { error } = await supabaseClient.from('exams').delete().eq('exam_id', examId);
            if (error) {
                console.error('Error deleting exam:', error);
                alert('Error deleting exam. Please try again.');
                return;
            }
            await loadSubjects();
        }

        // 7Ô∏è‚É£ Logout
        logoutBtn.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        });

        // Help
        helpBtn.addEventListener('click', () => {
            alert(
`How it works:
1. New users are automatically created with four compulsory subjects (Mathematics, First Additional Language, Home Language, Life Orientation) when the profile is first inserted on the server.
2. Compulsory subjects are marked as compulsory and cannot be deleted, but you can rename them.
3. Advanced subjects do NOT count toward your overall average.
4. Overall average uses compulsory subjects + top 3 non-compulsory non-advanced subjects.`
            );
        });

        // 8Ô∏è‚É£ Close modals on outside click
        window.addEventListener('click', e => {
            if (e.target === subjectModal) subjectModal.style.display = 'none';
            if (e.target === examModal) examModal.style.display = 'none';
        });

        // 9Ô∏è‚É£ Delegate button clicks in subjects container
        subjectsContainer.addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.dataset.action;
            const id = btn.dataset.id;
            const subjectId = btn.dataset.subjectId;

            if (action === 'edit-subject') {
                await openSubjectModal(id);
            } else if (action === 'delete-subject') {
                await deleteSubject(id);
            } else if (action === 'add-exam') {
                await openExamModal(id, null);
            } else if (action === 'edit-exam') {
                await openExamModal(subjectId || id, id);
            } else if (action === 'delete-exam') {
                await deleteExam(id);
            }
        });

        // Initial load
        await loadSubjects();

    })();
    </script>
</body>
</html>
